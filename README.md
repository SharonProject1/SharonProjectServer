# 무궁화 꽃 게임 서버

이 서버는 Express를 사용하여 "무궁화 꽃이 피었습니다" 게임의 멀티플레이어 상호작용을 처리합니다. 플레이어의 접속, 게임 상태 관리, 준비 상태 체크 등을 지원합니다.

## 서버 주소 및 기본 포트
- **`http://sharonproject.ddns.net:8080/`**

## API 엔드포인트

### 메인 페이지

- **`GET /`**  
  - 환영 메시지를 반환합니다.
  - **응답**: `"Welcome To 무궁화 꽃 게임"`

### 플레이어 관련 엔드포인트

- **`GET /join/:id?number=123`**  
  - 서버에 플레이어를 추가합니다.
  - **파라미터**: `id` - 플레이어의 고유 식별자
  - **쿼리**: `number` - 플레이어의 고유 번호
  - **응답**:
    - `200`: 성공적으로 참가
    - `403`: 이미 존재하는 ID이거나 서버가 가득 찬 경우

- **`GET /check/:id`**  
  - 플레이어가 여전히 연결되어 있는지 확인하고, 대기 시간을 초기화합니다.
  - **파라미터**: `id` - 플레이어의 고유 식별자
  - **응답**: `{ "connect": true }` (연결됨), `{ "connect": false }` (연결되지 않음)

- **`GET /ready/:id`**  
  - 플레이어의 준비 상태를 `true`로 설정합니다.
  - **파라미터**: `id` - 플레이어의 고유 식별자
  - **응답**:
    - `200`: 준비 상태가 `true`로 설정됨
    - `404`: 플레이어를 찾을 수 없음

- **`GET /notready/:id`**  
  - 플레이어의 준비 상태를 `false`로 설정합니다.
  - **파라미터**: `id` - 플레이어의 고유 식별자
  - **응답**:
    - `200`: 준비 상태가 `false`로 설정됨
    - `404`: 플레이어를 찾을 수 없음

- **`GET /falled/:id`**  
  - 탈락한 플레이어를 제거합니다.
  - **파라미터**: `id` - 플레이어의 고유 식별자

### 게임 상태 엔드포인트

- **`GET /state`**  
  - 현재 게임 상태를 반환합니다.
  - **응답**:
    - `isPlaying`: 게임이 진행 중인지 여부
    - `isVoicing`: 음성 안내가 활성화되어 있는지 여부
    - `isCounting`: 게임이 카운트다운 중인지 여부
    - `serverFPS`: 서버의 초당 프레임 수
    - `leftCountDownFrame`: 카운트다운에서 남은 프레임 수
    - `numberOfPlayers`: 현재 접속한 플레이어 수
    - `playFrame`: 게임 플레이 현재의 프레임 (플레이 타임 계산을 위함)
   
- **`GET /ard`**
  - 아두이노가 다음 어떤 행동을 해야하는지 배열을 반환합니다.
  - **응답**:
    - `do`: 다음 행동 코드 배열
   
### 아두이노 관련 엔드포인트
  - **`GET /ardIsVoicing`**
    - 아두이노에서 음성이 시작되면 서버에 알립니다.
    - **응답**:
      - `200`: 정상 처리됨
   
  - **`GET /ardIsNotVoicing`**
    - 아두이노에서 음성이 종료되면 서버에 알립니다.
    - **응답**:
      - `200`: 정상 처리됨
     
  - **`GET /ardSurvive?number=123`**
    - 아두이노에서 생존자가 발생하면 서버에 알립니다.
    - **쿼리**: `number`

## About activityCodes (다음 행동 코드 배열)
- 아두이노는 서버에게 주기적으로 GET 요청을 보내 activityCodes를 반환받아 행동합니다.
  - `0`: 아무 행동 없음
  - `1`: 게임을 시작, 초기화 및 카운트다운 진행
  - `2`: 음성 재생 시작
  - `3`: 모터를 회전하여 벽을 바라봄
  - `4`: 모터를 회전하여 플레이어를 바라봄
  - `5`: 제한시간으로 인해 게임이 종료됨
  - `6`: 플레이어가 한 명 남아 게임이 종료됨
 
***

# 서버 내장 함수

서버에 내장되어 있는 함수입니다.

# 함수 설명

## 기본 연산 함수

### `ReadyPlayers()`
- **설명**: 준비된 플레이어와 전체 플레이어 수를 반환합니다.
- **반환값**: `[readyPlayer<int>, Player<int>]`
- **작동 방식**: 
  - 모든 플레이어를 순회하며 준비 상태를 확인합니다.
  - 준비된 플레이어 수와 총 플레이어 수를 반환합니다.

### `NumOfPlayers()`
- **설명**: 총 플레이어 수를 반환합니다.
- **반환값**: `Number`
- **작동 방식**: 
  - `players` 배열의 길이를 반환합니다.

### `Randoms()`
- **설명**: 두 실수 사이의 랜덤 값을 반환합니다.
- **매개변수**:
  - `min`: 최소값
  - `max`: 최대값
- **반환값**: `randomNumber`
- **작동 방식**: 
  - 배열의 합을 배열의 길이로 나눕니다.
 
### `Averages()`
- **설명**: 배열의 평균 값을 반환합니다.
- **매개변수**:
  - `arr`: 평균을 구할 배열
- **반환값**: `average`
- **작동 방식**: 
  - `[min, max]` 범위 내 랜덤 값을 생성합니다.

### `NextRandom()`
- **설명**:  
  `minLoopFrame`과 `maxLoopFrame` 값을 갱신합니다. 갱신 과정은 다음과 같습니다:
  1. 현재 `loopFrameArray`의 평균값(`a`)을 계산합니다.
  2. `minLoopFrame`과 `maxLoopFrame`의 중간값(`mid`)과 차이(`diff`)를 구하고, 이를 감소 비율(`DECREASE_RATIO`)에 따라 줄입니다.
  3. 평균값(`a`)과 중간값(`mid`) 간의 차이에 가중치(`MIDDLE_WEIGHT`)를 적용해, 새로운 `minLoopFrame`과 `maxLoopFrame` 값을 계산합니다.
  4. 결과적으로 `minLoopFrame`과 `maxLoopFrame`은 최소값(`LEASTLOOPFRAME`) 이상으로 유지됩니다.
  5. 자세한 내용은 서버 코드를 확인해주세요.

- **수식 개요**:  
  - 새로운 **`minLoopFrame`**: `Max((mid - diff) + (mid - a) * MIDDLE_WEIGHT, LEASTLOOPFRAME)`
  - 새로운 **`maxLoopFrame`**: `Max((mid - diff) + (mid - a) * MIDDLE_WEIGHT, LEASTLOOPFRAME)`
    
- **파라미터**: 없음
- **반환값**: 없음

---

## 게임 진행 함수

### `StartCount()`
- **설명**: 게임 시작 카운트다운을 활성화합니다.
- **반환값**: 없음

### `Start()`
- **설명**: 게임을 시작합니다. 이 함수는 한 번만 실행됩니다.
- **반환값**: 없음
- **작동 방식**:
  - 카운트다운을 비활성화하고 게임 상태를 활성화합니다.

### `DoVoice()`
- **설명**: 음성 재생을 시작합니다.
- **반환값**: 없음
- **작동 방식**:
  - 랜덤 루프 프레임 값을 계산하고, 음성 재생 및 모터 회전 작업을 추가합니다.

### `CheckConnect()`
- **설명**: 각 플레이어의 연결 상태를 확인합니다.
- **반환값**: 없음
- **작동 방식**:
  - 비활성화된 플레이어를 제거하고 활성화 상태를 갱신합니다.

### `ArdCheckConnect()`
- **설명**: 아두이노의 연결 상태를 확인합니다.
- **반환값**: 없음
- **작동 방식**:
  - 마지막 확인 프레임을 기준으로 연결 상태를 설정합니다.

### `ArdActivityCodeAdd()`
- **설명**: 아두이노 코드 배열를 추가합니다.
- **반환값**: 없음
- **작동 방식**:
  - 아두이노 작업 배열을 갱신합니다.

### `ArdActivityCodeRemove()`
- **설명**: 아두이노 코드 배열를 초기화합니다.
- **반환값**: 없음

### `PlayOnReady()`
- **설명**: 준비 상태에서 실행되는 함수입니다.
- **반환값**: 없음
- **작동 방식**:
  - 플레이어 연결을 확인하고, 모든 플레이어가 준비된 경우 카운트다운을 시작합니다.

### `PlayOnCounting()`
- **설명**: 카운트다운 중 주기적으로 실행됩니다.
- **반환값**: 없음
- **작동 방식**:
  - 카운트다운 시간이 끝나면 게임을 시작합니다.

### `PlayOnGame()`
- **설명**: 게임 진행 중 주기적으로 실행됩니다.
- **반환값**: 없음
- **작동 방식**:
  - 게임 프레임을 갱신하고 음성 재생 조건을 확인합니다.
